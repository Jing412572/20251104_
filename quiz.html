<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>測驗系統</title>
    <script src="libraries/p5.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #F5F5DC; /* 米白色 */
            color: #333;
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        .quiz-container {
            width: 80vw; /* 占全螢幕寬的80% */
            height: 90vh; /* 占全螢幕高的90% */
            overflow-y: auto; /* 當內容過多時允許滾動 */
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            position: relative; /* 為了讓 p5.js canvas 定位 */
            display: flex;
            flex-direction: column;
        }
        #result-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }
        #result-canvas[data-p5-canvas-id] {
            pointer-events: none;
        }
        #feedback-text {
            font-style: italic;
            text-align: center;
            font-size: 1.1em;
            margin: 20px 0;
        }
        #progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 25px;
        }
        #progress-bar {
            height: 10px;
            width: 0%;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.4s ease-in-out;
        }
        h1 {
            color: #1A53C0;
            text-align: center;
            margin-bottom: 30px;
        }
        #question-text {
            margin-bottom: 20px; /* 增加題目與選項之間的距離 */
            text-align: center; /* 將題目文字置中 */
        }
        .question {
            margin-bottom: 25px;
            border-left: 3px solid #f7d002;
            padding-left: 15px;
        }
        .options label {
            display: block;
            margin-bottom: 12px;
            text-align: center; /* 選項文字置中 */
            cursor: pointer;
        }
        button {
            padding: 12px 25px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        .button-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
        }
        #nextBtn {
            background-color: #1A53C0;
            color: white;
        }
        #submitBtn {
            background-color: #1A53C0;
            color: white;
        }
        #submitBtn:hover {
            background-color: #144299;
        }
        #nextBtn:hover {
            background-color: #144299;
        }
        #retakeBtn {
            background-color: #007bff;
            color: white;
        }
        #retakeBtn:hover {
            background-color: #0069d9;
        }
        #backBtn {
            background-color: #f71735;
            color: white;
        }
        #backBtn:hover {
            background-color: #c7122b;
        }
        #backBtn-result {
            background-color: #f71735;
            color: white;
        }
        #backBtn-result:hover {
            background-color: #c7122b;
        }
        #result {
            margin-top: 25px;
            font-weight: bold;
            font-size: 18px;
        }
        #review-container {
            margin-top: 40px;
            border-top: 1px solid #ddd;
            flex-shrink: 0; /* 防止回顧區塊在空間不足時被壓縮 */
            padding-top: 20px;
        }
        .review-item {
            margin-bottom: 20px;
            padding-left: 15px;
            border-left: 3px solid #eee;
        }
        .review-question {
            font-weight: bold;
        }
        .review-options label {
            display: block;
            margin-bottom: 5px;
        }
        .correct-answer {
            color: #28a745;
            font-weight: bold;
        }
        .incorrect-answer {
            color: #dc3545;
            text-decoration: line-through;
        }
    </style>
</head>
<body>

    <div id="quiz-container" class="quiz-container">
        <h1>測驗系統</h1>

        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>

        <div id="question-container" class="question">
            <p id="question-text"></p>
            <div id="options-container" class="options">
                <!-- 選項會由 JavaScript 動態生成 -->
            </div>
        </div>

        <div class="button-container">
            <button id="backBtn">返回主頁</button>
            <button id="nextBtn" style="display: none;">下一題</button>
        </div>
    </div>

    <div id="result-container" class="quiz-container" style="display: none;">
        <h1>測驗結果</h1>
        <div id="result-canvas"></div>
        <p id="score-text"></p>
        <p id="result-summary"></p>
        <p id="feedback-text"></p>
        <div id="review-container">
            <h2>題目回顧</h2>
            <!-- 回顧內容會由 JavaScript 動態生成 -->
        </div>
        <div class="button-container">
            <button id="backBtn-result">返回主頁</button>
            <button id="retakeBtn">重新測驗</button>
        </div>
    </div>

    <script>
        let p5sketch = null;
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];

        // Fisher-Yates (aka Knuth) Shuffle
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 載入並解析 CSV 檔案
        async function loadQuestions() {
            try {
                const response = await fetch('questions.csv');
                const csvText = await response.text();
                questions = csvText.trim().split('\n').map(line => {
                    // 這個正規表示式可以處理被雙引號包起來的欄位，即使裡面有逗號
                    const regex = /(?:"([^"]*(?:""[^"]*)*)"|([^",\s]*))(?:\s*,\s*|\s*$)/g;
                    const parts = Array.from(line.matchAll(regex), m => m[1] || m[2]);

                    return {
                        question: parts[0],
                        options: { a: parts[1], b: parts[2], c: parts[3] },
                        correct: parts[4]
                    };
                });
                questions = shuffle(questions);
                updateProgressBar(); // 初始化進度條
                displayQuestion(currentQuestionIndex);
            } catch (error) {
                console.error('無法載入或解析 questions.csv:', error);
                document.getElementById('question-text').innerText = '無法載入題庫，請確認 questions.csv 檔案是否存在。';
            }
        }

        // 顯示指定題號的題目和選項
        function displayQuestion(index) {
            const questionData = questions[index];
            document.getElementById('question-text').innerText = (index + 1) + '. ' + questionData.question;
            
            const optionsContainer = document.getElementById('options-container');
            optionsContainer.innerHTML = '';
            for (const key in questionData.options) {
                const label = document.createElement('label');
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'q' + index;
                radio.value = key;
                label.appendChild(radio);
                label.appendChild(document.createTextNode(' ' + questionData.options[key]));
                optionsContainer.appendChild(label);
            }

            // 監聽選項點擊，顯示「下一題」按鈕
            optionsContainer.addEventListener('click', () => {
                document.getElementById('nextBtn').style.display = 'inline-block';
            }, { once: true });
        }

        // 更新進度條
        function updateProgressBar() {
            const progress = (currentQuestionIndex / questions.length) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        }

        // 計算並顯示結果
        function calculateAndShowResults() {
            let correctCount = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].correct) {
                    correctCount++;
                }
            }
            const score = (correctCount / questions.length) * 100;

            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('result-container').style.display = 'block';
            document.getElementById('score-text').innerText = `總題數：${questions.length} 題，答對題數：${correctCount} 題`;
            document.getElementById('result-summary').innerText = `最終得分：${score.toFixed(0)} 分`;

            let feedback = '';
            if (score === 100) {
                feedback = '太棒了！你完全掌握了！';
            } else if (score >= 60) {
                feedback = '做得不錯！還差一點就完美了！';
            } else if (score > 0) {
                feedback = '繼續加油！多練習幾次就會更好！';
            } else {
                feedback = '別灰心！再試一次吧！';
            }
            document.getElementById('feedback-text').innerText = feedback;

            if (!p5sketch) {
                p5sketch = new p5(confettiSketch, 'result-canvas');
            }
            p5sketch.updateParticles(correctCount);
            displayReview();
        }

        // 顯示題目回顧
        function displayReview() {
            const reviewContainer = document.getElementById('review-container');
            let reviewHTML = '';
            for (let i = 0; i < questions.length; i++) {
                const q = questions[i];
                const userAnswer = userAnswers[i];
                const isCorrect = userAnswer === q.correct;
                reviewHTML += `<div class="review-item"><p class="review-question">${i + 1}. ${q.question}</p><div class="review-options">`;
                for (const key in q.options) {
                    let className = '';
                    if (key === q.correct) className = 'correct-answer';
                    else if (key === userAnswer && !isCorrect) className = 'incorrect-answer';
                    reviewHTML += `<label class="${className}">${q.options[key]}</label>`;
                }
                reviewHTML += `</div></div>`;
            }
            reviewContainer.innerHTML = reviewHTML;
        }

        // 按鈕事件監聽
        document.getElementById('nextBtn').addEventListener('click', function() {
            const selected = document.querySelector(`input[name="q${currentQuestionIndex}"]:checked`);
            userAnswers[currentQuestionIndex] = selected ? selected.value : null;
            this.style.display = 'none';
            currentQuestionIndex++;
            if (currentQuestionIndex < questions.length) {
                updateProgressBar();
                displayQuestion(currentQuestionIndex);
                if (currentQuestionIndex === questions.length - 1) {
                    this.innerText = '提交答案';
                }
            } else {
                calculateAndShowResults();
            }
        });

        function resetQuiz() {
            // 隱藏結果，顯示測驗
            document.getElementById('result-container').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'flex';

            // 重置狀態
            currentQuestionIndex = 0;
            userAnswers = [];
            
            // 重置 UI
            document.getElementById('nextBtn').innerText = '下一題';
            document.getElementById('nextBtn').style.display = 'none';

            // 停止並移除 p5.js 動畫
            if (p5sketch) {
                p5sketch.remove();
                p5sketch = null;
            }

            // 重新載入題目並開始測驗
            loadQuestions();
        }

        document.getElementById('backBtn').addEventListener('click', () => window.location.href = 'index.html');
        document.getElementById('backBtn-result').addEventListener('click', () => window.location.href = 'index.html');
        document.getElementById('retakeBtn').addEventListener('click', resetQuiz);

        // 啟動測驗
        window.onload = loadQuestions;

        // p5.js 彩帶動畫
        const confettiSketch = (p) => {
            let particles = [];
            p.setup = () => {
                const container = document.getElementById('result-container');
                const canvas = p.createCanvas(container.offsetWidth, container.offsetHeight);
                p.noStroke();
            };
            p.updateParticles = (correctCount) => {
                particles = [];
                const particleCount = correctCount * 50;
                for (let i = 0; i < particleCount; i++) {
                    particles.push({
                        x: p.random(p.width), y: p.random(-p.height, 0),
                        w: p.random(5, 15), h: p.random(5, 15),
                        color: p.color(p.random(150, 255), p.random(150, 255), p.random(150, 255), 200),
                        ySpeed: p.random(2, 5)
                    });
                }
            };
            p.draw = () => {
                p.clear();
                for (let particle of particles) {
                    p.fill(particle.color);
                    p.rect(particle.x, particle.y, particle.w, particle.h);
                    particle.y += particle.ySpeed;
                    if (particle.y > p.height) {
                        particle.y = p.random(-100, 0);
                        particle.x = p.random(p.width);
                    }
                }
            };
        };
    </script>

</body>
</html>